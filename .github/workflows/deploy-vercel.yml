name: Deploy to Vercel

on:
  push:
    branches:
      - main      
      - master
      - 'release/**'
  pull_request:
    branches:
      - main
      - master
      - 'release/**'
    types: [opened, synchronize, reopened]  

jobs:
 
  check-migrations:
    runs-on: ubuntu-latest
    name: Check for Migration Changes
    if: github.repository == 'xzy1124/keco-studio'
    outputs:
      has-migrations: ${{ steps.check.outputs.has-migrations }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # è·å–å®Œæ•´å†å²ä»¥ä¾¿æ¯”è¾ƒåˆ†æ”¯

      - name: Check for migration changes
        id: check
        run: |
          echo "ğŸ” å¼€å§‹æ£€æŸ¥è¿ç§»æ–‡ä»¶..."
          echo "å½“å‰åˆ†æ”¯: ${{ github.ref }}"
          echo "å½“å‰ commit: ${{ github.sha }}"
          
          # åˆ—å‡ºæ‰€æœ‰è¿ç§»æ–‡ä»¶ï¼ˆç”¨äºè°ƒè¯•ï¼‰
          echo "ğŸ“‹ å½“å‰åˆ†æ”¯çš„è¿ç§»æ–‡ä»¶ï¼š"
          if [ -d "supabase/migrations" ]; then
            ls -la supabase/migrations/*.sql 2>/dev/null || echo "  æ²¡æœ‰æ‰¾åˆ° .sql æ–‡ä»¶"
          else
            echo "  supabase/migrations ç›®å½•ä¸å­˜åœ¨"
          fi
          
          # ç¡®å®š base åˆ†æ”¯
          if [[ "${{ github.ref }}" == "refs/heads/main" ]] || [[ "${{ github.ref }}" == "refs/heads/master" ]]; then
            BASE_BRANCH="origin/main"
            # å¦‚æœ main ä¸å­˜åœ¨ï¼Œå°è¯• master
            if ! git rev-parse --verify "$BASE_BRANCH" >/dev/null 2>&1; then
              BASE_BRANCH="origin/master"
            fi
          elif [[ "${{ github.ref }}" =~ ^refs/heads/release ]]; then
            # release åˆ†æ”¯ä¸ main æ¯”è¾ƒ
            BASE_BRANCH="origin/main"
            if ! git rev-parse --verify "$BASE_BRANCH" >/dev/null 2>&1; then
              BASE_BRANCH="origin/master"
            fi
          else
            # PR æˆ–å…¶ä»–æƒ…å†µï¼Œä¸ main æ¯”è¾ƒ
            BASE_BRANCH="origin/main"
            if ! git rev-parse --verify "$BASE_BRANCH" >/dev/null 2>&1; then
              BASE_BRANCH="origin/master"
            fi
          fi
          
          echo "Base åˆ†æ”¯: $BASE_BRANCH"
          
          # æ£€æŸ¥å½“å‰åˆ†æ”¯ç›¸å¯¹äº base åˆ†æ”¯çš„è¿ç§»æ–‡ä»¶å˜åŒ–
          # å¦‚æœ base åˆ†æ”¯ä¸å­˜åœ¨ï¼ˆé¦–æ¬¡æ¨é€ï¼‰ï¼Œæ£€æŸ¥æ˜¯å¦æœ‰è¿ç§»æ–‡ä»¶
          if ! git rev-parse --verify "$BASE_BRANCH" >/dev/null 2>&1; then
            echo "âš ï¸ Base åˆ†æ”¯ä¸å­˜åœ¨ï¼Œæ£€æŸ¥æ˜¯å¦æœ‰è¿ç§»æ–‡ä»¶..."
            if [ -d "supabase/migrations" ] && [ "$(ls -A supabase/migrations/*.sql 2>/dev/null)" ]; then
              echo "has-migrations=true" >> $GITHUB_OUTPUT
              echo "âœ… æ£€æµ‹åˆ°è¿ç§»æ–‡ä»¶ï¼ˆé¦–æ¬¡æ¨é€ï¼‰"
            else
              echo "has-migrations=false" >> $GITHUB_OUTPUT
              echo "â„¹ï¸ æ²¡æœ‰è¿ç§»æ–‡ä»¶"
            fi
          else
            # è·å– base åˆ†æ”¯çš„ commit
            git fetch origin ${BASE_BRANCH#origin/}:${BASE_BRANCH#origin/} 2>/dev/null || true
            
            # æ¯”è¾ƒå½“å‰åˆ†æ”¯ä¸ base åˆ†æ”¯çš„å·®å¼‚
            MIGRATION_FILES=$(git diff --name-only "$BASE_BRANCH" HEAD | grep "^supabase/migrations/" || true)
            
            if [ -n "$MIGRATION_FILES" ]; then
              echo "has-migrations=true" >> $GITHUB_OUTPUT
              echo "âœ… æ£€æµ‹åˆ°è¿ç§»æ–‡ä»¶å˜åŒ–ï¼ˆç›¸å¯¹äº $BASE_BRANCHï¼‰"
              echo "å˜åŒ–çš„è¿ç§»æ–‡ä»¶ï¼š"
              echo "$MIGRATION_FILES" | while read -r file; do
                echo "  - $file"
              done
            else
              # å³ä½¿æ²¡æœ‰æ–‡ä»¶å˜åŒ–ï¼Œä¹Ÿæ£€æŸ¥æ˜¯å¦æœ‰è¿ç§»æ–‡ä»¶å­˜åœ¨
              # å› ä¸ºå¯èƒ½ä¹‹å‰çš„è¿ç§»æ²¡æœ‰æˆåŠŸåº”ç”¨
              if [ -d "supabase/migrations" ] && [ "$(ls -A supabase/migrations/*.sql 2>/dev/null)" ]; then
                echo "has-migrations=true" >> $GITHUB_OUTPUT
                echo "âœ… æ£€æµ‹åˆ°è¿ç§»æ–‡ä»¶ï¼ˆè™½ç„¶æ²¡æœ‰å˜åŒ–ï¼Œä½†å¯èƒ½å­˜åœ¨æœªåº”ç”¨çš„è¿ç§»ï¼‰"
              else
                echo "has-migrations=false" >> $GITHUB_OUTPUT
                echo "â„¹ï¸ æ²¡æœ‰è¿ç§»æ–‡ä»¶å˜åŒ–ï¼ˆç›¸å¯¹äº $BASE_BRANCHï¼‰"
              fi
            fi
          fi

  
  migrate-database:
    runs-on: ubuntu-latest
    name: Run Supabase Migrations
    needs: check-migrations
    # å¯¹äº main å’Œ release åˆ†æ”¯ï¼Œæ€»æ˜¯è¿è¡Œè¿ç§»ï¼ˆsupabase db push æ˜¯å¹‚ç­‰çš„ï¼Œåªä¼šåº”ç”¨æœªåº”ç”¨çš„è¿ç§»ï¼‰
    # è¿™æ ·å¯ä»¥ç¡®ä¿å³ä½¿ä¹‹å‰çš„è¿ç§»å¤±è´¥ï¼Œä¹Ÿèƒ½é‡æ–°åº”ç”¨
    if: |
      github.repository == 'xzy1124/keco-studio' && (
        needs.check-migrations.outputs.has-migrations == 'true' ||
        github.ref == 'refs/heads/main' ||
        github.ref == 'refs/heads/master' ||
        startsWith(github.ref, 'refs/heads/release/')
      )
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Check migration files exist
        run: |
          if [ ! -d "supabase/migrations" ] || [ -z "$(ls -A supabase/migrations/*.sql 2>/dev/null)" ]; then
            echo "âš ï¸ æ²¡æœ‰æ‰¾åˆ°è¿ç§»æ–‡ä»¶ï¼Œè·³è¿‡è¿ç§»ä»»åŠ¡"
            exit 0
          else
            echo "âœ… æ‰¾åˆ°è¿ç§»æ–‡ä»¶ï¼Œç»§ç»­æ‰§è¡Œè¿ç§»"
            ls -la supabase/migrations/*.sql
          fi

      # æ ¹æ®åˆ†æ”¯é€‰æ‹© Supabase é¡¹ç›®å’Œå¯¹åº”çš„ Access Token
      # main åˆ†æ”¯ â†’ Production, release åˆ†æ”¯ â†’ Preview
      - name: Select Supabase Project and Token
        id: select-project
        env:
          PROD_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN_PROD }}
          PREVIEW_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN_PREVIEW }}
          GENERAL_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
        run: |
          if [[ "${{ github.ref }}" == "refs/heads/main" ]] || [[ "${{ github.ref }}" == "refs/heads/master" ]]; then
            # main åˆ†æ”¯ä½¿ç”¨ Production ç¯å¢ƒ
            echo "project-ref=${{ secrets.SUPABASE_PROJECT_REF_PROD }}" >> $GITHUB_OUTPUT
            echo "environment=production" >> $GITHUB_OUTPUT
            # å¦‚æœé…ç½®äº†å•ç‹¬çš„ Production Tokenï¼Œä½¿ç”¨å®ƒï¼›å¦åˆ™ä½¿ç”¨é€šç”¨çš„ Token
            if [ -n "$PROD_TOKEN" ] && [ "$PROD_TOKEN" != "" ]; then
              echo "access-token=$PROD_TOKEN" >> $GITHUB_OUTPUT
              echo "âœ… ä½¿ç”¨ Production Supabase é¡¹ç›® (å•ç‹¬ Token)"
            else
              echo "access-token=$GENERAL_TOKEN" >> $GITHUB_OUTPUT
              echo "âœ… ä½¿ç”¨ Production Supabase é¡¹ç›® (é€šç”¨ Token)"
            fi
          elif [[ "${{ github.ref }}" =~ ^refs/heads/release ]]; then
            # release åˆ†æ”¯ï¼ˆåŒ…æ‹¬ release/**ï¼‰ä½¿ç”¨ Preview ç¯å¢ƒ
            echo "project-ref=${{ secrets.SUPABASE_PROJECT_REF_PREVIEW }}" >> $GITHUB_OUTPUT
            echo "environment=preview" >> $GITHUB_OUTPUT
            # å¦‚æœé…ç½®äº†å•ç‹¬çš„ Preview Tokenï¼Œä½¿ç”¨å®ƒï¼›å¦åˆ™ä½¿ç”¨é€šç”¨çš„ Token
            if [ -n "$PREVIEW_TOKEN" ] && [ "$PREVIEW_TOKEN" != "" ]; then
              echo "access-token=$PREVIEW_TOKEN" >> $GITHUB_OUTPUT
              echo "âœ… ä½¿ç”¨ Preview Supabase é¡¹ç›® (release åˆ†æ”¯, å•ç‹¬ Token)"
            else
              echo "access-token=$GENERAL_TOKEN" >> $GITHUB_OUTPUT
              echo "âœ… ä½¿ç”¨ Preview Supabase é¡¹ç›® (release åˆ†æ”¯, é€šç”¨ Token)"
            fi
          else
            # å…¶ä»–æƒ…å†µï¼ˆPR ç­‰ï¼‰ä½¿ç”¨ Preview ç¯å¢ƒ
            echo "project-ref=${{ secrets.SUPABASE_PROJECT_REF_PREVIEW }}" >> $GITHUB_OUTPUT
            echo "environment=preview" >> $GITHUB_OUTPUT
            if [ -n "$PREVIEW_TOKEN" ] && [ "$PREVIEW_TOKEN" != "" ]; then
              echo "access-token=$PREVIEW_TOKEN" >> $GITHUB_OUTPUT
              echo "âœ… ä½¿ç”¨ Preview Supabase é¡¹ç›® (å•ç‹¬ Token)"
            else
              echo "access-token=$GENERAL_TOKEN" >> $GITHUB_OUTPUT
              echo "âœ… ä½¿ç”¨ Preview Supabase é¡¹ç›® (é€šç”¨ Token)"
            fi
          fi

      - name: Link to Supabase project
        run: |
          echo "ğŸ”— é“¾æ¥åˆ° Supabase é¡¹ç›®: ${{ steps.select-project.outputs.environment }}"
          echo "ğŸ“‹ Project Ref: ${{ steps.select-project.outputs.project-ref }}"
          supabase link --project-ref ${{ steps.select-project.outputs.project-ref }}
        env:
          SUPABASE_ACCESS_TOKEN: ${{ steps.select-project.outputs.access-token }}

      - name: Push database migrations
        run: |
          echo "ğŸš€ å¼€å§‹æ¨é€æ•°æ®åº“è¿ç§»åˆ° ${{ steps.select-project.outputs.environment }} ç¯å¢ƒ..."
          supabase db push --include-all
          echo "âœ… è¿ç§»å®Œæˆ"
        env:
          SUPABASE_ACCESS_TOKEN: ${{ steps.select-project.outputs.access-token }}
        continue-on-error: false  


  deploy:
    runs-on: ubuntu-latest
    needs: [check-migrations, migrate-database]  
    if: github.repository == 'xzy1124/keco-studio' && always() && (needs.migrate-database.result == 'success' || needs.migrate-database.result == 'skipped')
    name: Deploy to Vercel
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run linter
        run: npm run lint
        continue-on-error: true  

      - name: Install Vercel CLI
        run: npm install --global vercel@latest

      # Determine deployment environment based on branch
      # main åˆ†æ”¯ â†’ Production, release åˆ†æ”¯ â†’ Preview
      - name: Determine deployment environment
        id: env
        run: |
          if [[ "${{ github.ref }}" == "refs/heads/main" ]] || [[ "${{ github.ref }}" == "refs/heads/master" ]]; then
            echo "environment=production" >> $GITHUB_OUTPUT
            echo "is_prod=true" >> $GITHUB_OUTPUT
            echo "deployment_target=production" >> $GITHUB_OUTPUT
            echo "âœ… éƒ¨ç½²åˆ° Production ç¯å¢ƒ (main åˆ†æ”¯)"
          elif [[ "${{ github.ref }}" =~ ^refs/heads/release ]]; then
            # release åˆ†æ”¯ï¼ˆåŒ…æ‹¬ release/**ï¼‰éƒ¨ç½²åˆ° Preview ç¯å¢ƒ
            echo "environment=preview" >> $GITHUB_OUTPUT
            echo "is_prod=false" >> $GITHUB_OUTPUT
            echo "deployment_target=preview" >> $GITHUB_OUTPUT
            echo "âœ… éƒ¨ç½²åˆ° Preview ç¯å¢ƒ (release åˆ†æ”¯)"
          else
            # PR ç­‰å…¶ä»–æƒ…å†µéƒ¨ç½²åˆ° Preview
            echo "environment=preview" >> $GITHUB_OUTPUT
            echo "is_prod=false" >> $GITHUB_OUTPUT
            echo "deployment_target=preview" >> $GITHUB_OUTPUT
            echo "âœ… éƒ¨ç½²åˆ° Preview ç¯å¢ƒ"
          fi

      # Pull Vercel environment variables based on deployment environment
      # This will automatically use the correct Supabase config (Production or Preview)
      # from Vercel Dashboard based on the environment determined above
      - name: Pull Vercel Environment Information
        run: vercel pull --yes --environment=${{ steps.env.outputs.environment }} --token=${{ secrets.VERCEL_TOKEN }}
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

      - name: Build Project Artifacts
        run: |
          if [[ "${{ steps.env.outputs.is_prod }}" == "true" ]]; then
            vercel build --prod --token=${{ secrets.VERCEL_TOKEN }}
          else
            vercel build --token=${{ secrets.VERCEL_TOKEN }}
          fi
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

      - name: Deploy Project Artifacts to Vercel
        run: |
          if [[ "${{ steps.env.outputs.is_prod }}" == "true" ]]; then
            # Production éƒ¨ç½²ï¼ˆmain åˆ†æ”¯ï¼‰
            echo "ğŸš€ éƒ¨ç½²åˆ° Production ç¯å¢ƒ..."
            vercel deploy --prebuilt --prod --token=${{ secrets.VERCEL_TOKEN }}
          elif [[ "${{ github.ref }}" =~ ^refs/heads/release/ ]]; then
            # Release åˆ†æ”¯éƒ¨ç½²åˆ° Preview ç¯å¢ƒï¼Œä½¿ç”¨å›ºå®šåŸŸå keco-release.vercel.app
            BRANCH_NAME=${GITHUB_REF#refs/heads/}
            echo "ğŸš€ éƒ¨ç½²åˆ° Preview ç¯å¢ƒ (Branch: $BRANCH_NAME)..."
            DEPLOYMENT_URL=$(vercel deploy --prebuilt --token=${{ secrets.VERCEL_TOKEN }})
            echo "ğŸ“¦ éƒ¨ç½² URL: $DEPLOYMENT_URL"
            echo "ğŸ”— è®¾ç½®åˆ«å keco-release.vercel.app..."
            vercel alias set "$DEPLOYMENT_URL" keco-release.vercel.app --token=${{ secrets.VERCEL_TOKEN }}
            echo "âœ… Release éƒ¨ç½²å®Œæˆï¼ŒBranch: $BRANCH_NAME"
            echo "ğŸŒ Release URL: https://keco-release.vercel.app"
          else
            # å…¶ä»– Preview éƒ¨ç½²ï¼ˆPR ç­‰ï¼‰
            echo "ğŸš€ éƒ¨ç½²åˆ° Preview ç¯å¢ƒ..."
            vercel deploy --prebuilt --token=${{ secrets.VERCEL_TOKEN }}
          fi
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
          