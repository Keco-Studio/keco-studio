name: Sync to Personal Repository

# Trigger conditions: push to main or PR merge to main
on:
  push:
    branches:
      - epic3-bugs
  pull_request:
    branches:
      - epic3-bugs
    types: [closed]  # Only trigger on PR merge (closed)

jobs:
  sync-to-personal:
    runs-on: ubuntu-latest
    
    # Only run in team repository and when PR is merged
    if: github.repository == 'Caerulean-ai/keco-studio' && (github.event_name == 'push' || (github.event_name == 'pull_request' && github.event.pull_request.merged == true))

    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history

      - name: Configure git
        run: |
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global user.name "github-actions[bot]"

      - name: Add personal repository as remote
        run: |
          git remote add personal https://x-access-token:${{ secrets.PERSONAL_GITHUB_TOKEN }}@github.com/xzy1124/keco-studio.git || true
          git remote set-url personal https://x-access-token:${{ secrets.PERSONAL_GITHUB_TOKEN }}@github.com/xzy1124/keco-studio.git

      - name: Verify token and push to personal repository
        run: |
          echo "ğŸš€ å¼€å§‹æ¨é€åˆ°ä¸ªäººä»“åº“..."
          
          # å…ˆæ£€æŸ¥ token æ˜¯å¦æœ‰æ•ˆ
          echo "ğŸ” éªŒè¯ token æƒé™..."
          TOKEN_VALID=$(curl -s -o /dev/null -w "%{http_code}" -H "Authorization: token ${{ secrets.PERSONAL_GITHUB_TOKEN }}" https://api.github.com/user)
          if [ "$TOKEN_VALID" != "200" ]; then
            echo "âŒ Token éªŒè¯å¤±è´¥ (HTTP $TOKEN_VALID)"
            echo "è¯·æ£€æŸ¥ PERSONAL_GITHUB_TOKEN secret æ˜¯å¦ï¼š"
            echo "  1. å·²æ­£ç¡®é…ç½®"
            echo "  2. å…·æœ‰ repo æƒé™ï¼ˆéœ€è¦å‹¾é€‰ 'repo' scopeï¼‰"
            echo "  3. æœªè¿‡æœŸ"
            exit 1
          fi
          echo "âœ… Token éªŒè¯æˆåŠŸ"
          
          # è·å–å½“å‰åˆ†æ”¯çš„ commit
          CURRENT_COMMIT=$(git rev-parse HEAD)
          CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD)
          echo "å½“å‰åˆ†æ”¯: $CURRENT_BRANCH"
          echo "å½“å‰ commit: $CURRENT_COMMIT"
          
          # æ¨é€åˆ°ä¸ªäººä»“åº“ï¼ˆä½¿ç”¨ --force ç¡®ä¿è¦†ç›–ï¼Œå› ä¸ºè¿™æ˜¯åŒæ­¥è„šæœ¬ï¼‰
          # å¦‚æœéœ€è¦ä¿ç•™ä¸ªäººä»“åº“çš„æ›´æ”¹ï¼Œå¯ä»¥æ”¹ä¸ºå…ˆ pull å† push
          echo "ğŸ“¤ æ¨é€åˆ° xzy1124/keco-studio:main..."
          if git push personal $CURRENT_BRANCH:main --force; then
            echo "âœ… æ¨é€æˆåŠŸ"
          else
            echo "âŒ æ¨é€å¤±è´¥"
            echo "å¯èƒ½çš„åŸå› ï¼š"
            echo "  1. Token æ²¡æœ‰ push æƒé™ï¼ˆéœ€è¦ 'repo' scope ä¸‹çš„ 'public_repo' æˆ– 'repo' æƒé™ï¼‰"
            echo "  2. ä¸ªäººä»“åº“ä¸å­˜åœ¨æˆ–æ— æ³•è®¿é—®"
            echo "  3. åˆ†æ”¯ä¿æŠ¤è§„åˆ™é˜»æ­¢äº†æ¨é€"
            exit 1
          fi
