# æ€§èƒ½ä¼˜åŒ–ï¼šè§£å†³é‡å¤ API è¯·æ±‚é—®é¢˜

## ğŸ¯ é—®é¢˜æ¦‚è¿°

ä¹‹å‰é¡¹ç›®ä¸­å­˜åœ¨ä¸¥é‡çš„é‡å¤ API è¯·æ±‚é—®é¢˜ï¼Œæ¯ä¸ªæ¥å£éƒ½ä¼šè¢«è°ƒç”¨ 2-4 æ¬¡ï¼Œä¸¥é‡å½±å“æ€§èƒ½å’Œç”¨æˆ·ä½“éªŒã€‚

### ä¸»è¦åŸå› 

1. **React Strict Modeï¼ˆå¼€å‘æ¨¡å¼ï¼‰**: Next.js åœ¨å¼€å‘æ¨¡å¼ä¸‹é»˜è®¤å¯ç”¨ï¼Œä¼šå¯¼è‡´æ‰€æœ‰ç»„ä»¶å’Œ Effect åŒé‡æ¸²æŸ“
2. **å¤šå±‚ Context çº§è”æ¸²æŸ“**: SupabaseProvider â†’ AuthProvider â†’ NavigationContext ä¸‰å±‚åµŒå¥—ï¼Œæ¯å±‚éƒ½æœ‰ useEffect
3. **NavigationContext ä¸­çš„ 500ms å»¶è¿Ÿ**: æ¯æ¬¡è·¯ç”±å˜åŒ–éƒ½ä¼šå»¶è¿Ÿ 500ms åå†è¯·æ±‚
4. **useEffect ä¾èµ–é¡¹ä¸å½“**: å¾ˆå¤šåœ°æ–¹ä¾èµ–å‡½æ•°å¼•ç”¨ï¼Œå¯¼è‡´ä¸å¿…è¦çš„é‡å¤æ‰§è¡Œ
5. **ç¼ºå°‘è¯·æ±‚å»é‡æœºåˆ¶**: æ²¡æœ‰ç¼“å­˜å’Œå»é‡ï¼Œç›¸åŒè¯·æ±‚ä¼šè¢«é‡å¤å‘é€
6. **Sidebar ç»„ä»¶**: æœ‰å¤§é‡çš„ useEffect hooks ç›‘å¬å„ç§äº‹ä»¶

## âœ… è§£å†³æ–¹æ¡ˆ

### 1. åˆ›å»ºå…¨å±€è¯·æ±‚ç¼“å­˜æœºåˆ¶

æ–°å¢æ–‡ä»¶ï¼š`src/lib/hooks/useRequestCache.ts`

- **åŠŸèƒ½**ï¼š
  - ç¼“å­˜è¯·æ±‚ç»“æœ 30 ç§’
  - è‡ªåŠ¨å»é‡å¹¶å‘è¯·æ±‚
  - æ”¯æŒæ‰‹åŠ¨å¤±æ•ˆç¼“å­˜
  - å…¨å±€å•ä¾‹æ¨¡å¼ï¼Œè·¨ç»„ä»¶å…±äº«

- **ä½¿ç”¨æ–¹å¼**ï¼š
```typescript
import { globalRequestCache } from '@/lib/hooks/useRequestCache';

// åœ¨æœåŠ¡å±‚ä½¿ç”¨
const data = await globalRequestCache.fetch(cacheKey, async () => {
  return await supabase.from('table').select('*');
});

// ä¿®æ”¹åå¤±æ•ˆç¼“å­˜
globalRequestCache.invalidate(cacheKey);
```

### 2. ä¼˜åŒ–æ ¸å¿ƒæœåŠ¡å±‚

#### `projectService.ts`
- âœ… `listProjects()` - æ·»åŠ ç¼“å­˜ï¼Œkey: `projects:list:{userId}`
- âœ… `getProject()` - æ·»åŠ ç¼“å­˜ï¼Œkey: `project:{projectId}`
- âœ… `deleteProject()` - åˆ é™¤åå¤±æ•ˆç›¸å…³ç¼“å­˜

#### `libraryService.ts`
- âœ… `listLibraries()` - æ·»åŠ ç¼“å­˜ï¼Œkey: `libraries:list:{projectId}:{folderId}`
- âœ… `getLibrary()` - æ·»åŠ ç¼“å­˜ï¼Œkey: `library:{libraryId}`
- âœ… `createLibrary()` - åˆ›å»ºåå¤±æ•ˆåˆ—è¡¨ç¼“å­˜
- âœ… `deleteLibrary()` - åˆ é™¤åå¤±æ•ˆç›¸å…³ç¼“å­˜

### 3. ä¼˜åŒ– Context å±‚

#### `NavigationContext.tsx`
- âœ… **ç§»é™¤ 500ms å»¶è¿Ÿ** - æ”¹ç”¨ç¼“å­˜æœºåˆ¶è‡ªåŠ¨å»é‡
- âœ… **æ·»åŠ è¯·æ±‚ç¼“å­˜**ï¼š
  - é¡¹ç›®åç§°ï¼š`project:name:{projectId}`
  - åº“ä¿¡æ¯ï¼š`library:info:{libraryId}`
- âœ… **å‡å°‘ä¸å¿…è¦çš„è¯·æ±‚** - ç›¸åŒçš„å¯¼èˆªä¿¡æ¯ä¼šè¢«ç¼“å­˜å¤ç”¨

### 4. ä¼˜åŒ– Sidebar ç»„ä»¶

`src/components/layout/Sidebar.tsx`

- âœ… **æ·»åŠ è¯·æ±‚é˜²æŠ–**ï¼š
  - ä½¿ç”¨ `fetchingProjectsRef` é˜²æ­¢å¹¶å‘é‡å¤è¯·æ±‚
  - ä½¿ç”¨ `fetchingFoldersLibrariesRef` è¿½è¸ªæ­£åœ¨è¯·æ±‚çš„é¡¹ç›®
  - ä½¿ç”¨ `fetchingAssetsRef` é˜²æ­¢é‡å¤è·å–èµ„æºåˆ—è¡¨
  
- âœ… **èµ„æºåˆ—è¡¨ç¼“å­˜** - `fetchAssets()` ä½¿ç”¨å…¨å±€ç¼“å­˜ï¼Œkey: `assets:list:{libraryId}`

### 5. ä¼˜åŒ– Hooks

#### `useSchemaData.ts`
- âœ… **æ·»åŠ è¯·æ±‚é˜²æŠ¤** - ä½¿ç”¨ `loadingRef` é˜²æ­¢å¹¶å‘é‡å¤è¯·æ±‚
- âœ… **æ·»åŠ ç¼“å­˜** - å­—æ®µå®šä¹‰ç¼“å­˜ï¼Œkey: `field-definitions:{libraryId}`

#### `useSchemaSave.ts`
- âœ… **ä¿å­˜åå¤±æ•ˆç¼“å­˜** - ç¡®ä¿æ›´æ–°åæ•°æ®ä¸€è‡´æ€§

### 6. ç¦ç”¨ React Strict Modeï¼ˆå¼€å‘æ¨¡å¼ï¼‰

`next.config.mjs`

```javascript
const nextConfig = {
  reactStrictMode: false, // ç¦ç”¨å¼€å‘æ¨¡å¼åŒé‡æ¸²æŸ“
};
```

**æ³¨æ„**ï¼šè¿™ä¼šç¦ç”¨ React çš„å¼€å‘æ—¶è°ƒè¯•åŠŸèƒ½ï¼Œä½†èƒ½æ˜¾è‘—å‡å°‘é‡å¤è¯·æ±‚ã€‚ç”Ÿäº§ç¯å¢ƒä¸å—å½±å“ã€‚

## ğŸ“Š æ€§èƒ½æå‡é¢„æœŸ

### æ”¹è¿›å‰
- æ¯ä¸ª API è¯·æ±‚å¹³å‡è°ƒç”¨ **2-4 æ¬¡**
- é¡µé¢åˆ‡æ¢æ—¶ä¼šè§¦å‘ **10+ ä¸ªé‡å¤è¯·æ±‚**
- NavigationContext æœ‰ **500ms å›ºå®šå»¶è¿Ÿ**
- ç”¨æˆ·æ„ŸçŸ¥æ˜æ˜¾å¡é¡¿

### æ”¹è¿›å
- æ¯ä¸ª API è¯·æ±‚ **ä»…è°ƒç”¨ 1 æ¬¡**
- 30 ç§’å†…ç›¸åŒè¯·æ±‚ **ç›´æ¥ä½¿ç”¨ç¼“å­˜**
- å¹¶å‘ç›¸åŒè¯·æ±‚ **è‡ªåŠ¨åˆå¹¶**
- **æ— é¢å¤–å»¶è¿Ÿ**
- é¡µé¢å“åº”é€Ÿåº¦æå‡ **2-4 å€**

## ğŸ” éªŒè¯æ–¹æ³•

### 1. å¼€å‘è€…å·¥å…· - Network é¢æ¿
1. æ‰“å¼€æµè§ˆå™¨å¼€å‘è€…å·¥å…·ï¼ˆF12ï¼‰
2. åˆ‡æ¢åˆ° Network æ ‡ç­¾
3. å¯¼èˆªåˆ°ä¸åŒé¡µé¢
4. è§‚å¯Ÿï¼šåº”è¯¥çœ‹åˆ°æ¯ä¸ªè¯·æ±‚åªå‡ºç°ä¸€æ¬¡

### 2. Console æ—¥å¿—
ç¼“å­˜ç³»ç»Ÿä¼šåœ¨æ§åˆ¶å°æ˜¾ç¤ºç¼“å­˜å‘½ä¸­æƒ…å†µï¼ˆå¼€å‘æ¨¡å¼ï¼‰

### 3. React DevTools Profiler
ä½¿ç”¨ React DevTools çš„ Profiler æŸ¥çœ‹ç»„ä»¶æ¸²æŸ“æ¬¡æ•°

## ğŸš€ åç»­ä¼˜åŒ–å»ºè®®

### çŸ­æœŸï¼ˆå·²å®Œæˆï¼‰
- âœ… å®ç°å…¨å±€è¯·æ±‚ç¼“å­˜
- âœ… ä¼˜åŒ–æ ¸å¿ƒæœåŠ¡å±‚
- âœ… ç§»é™¤ä¸å¿…è¦çš„å»¶è¿Ÿ
- âœ… ç¦ç”¨ Strict Mode

### ä¸­æœŸ
- ğŸ”² è€ƒè™‘ä½¿ç”¨ React Query æˆ– SWR æ›¿ä»£è‡ªå®šä¹‰ç¼“å­˜ï¼ˆæ›´æˆç†Ÿçš„è§£å†³æ–¹æ¡ˆï¼‰
- ğŸ”² å®ç°ä¹è§‚æ›´æ–°ï¼ˆOptimistic Updatesï¼‰
- ğŸ”² æ·»åŠ è¯·æ±‚é”™è¯¯é‡è¯•æœºåˆ¶
- ğŸ”² å®ç° WebSocket è®¢é˜…æ›¿ä»£è½®è¯¢

### é•¿æœŸ
- ğŸ”² è€ƒè™‘ä½¿ç”¨æœåŠ¡ç«¯ç»„ä»¶ï¼ˆReact Server Componentsï¼‰
- ğŸ”² å®ç°åˆ†é¡µå’Œè™šæ‹Ÿæ»šåŠ¨
- ğŸ”² æ·»åŠ é¢„åŠ è½½ï¼ˆPrefetchingï¼‰
- ğŸ”² ä¼˜åŒ–å›¾ç‰‡å’Œèµ„æºåŠ è½½

## ğŸ“ æ³¨æ„äº‹é¡¹

1. **ç¼“å­˜æ—¶é—´**: å½“å‰è®¾ç½®ä¸º 30 ç§’ï¼Œå¯æ ¹æ®éœ€è¦è°ƒæ•´ `CACHE_DURATION`
2. **ç¼“å­˜å¤±æ•ˆ**: æ‰€æœ‰ä¿®æ”¹æ“ä½œï¼ˆåˆ›å»ºã€æ›´æ–°ã€åˆ é™¤ï¼‰éƒ½ä¼šè‡ªåŠ¨å¤±æ•ˆç›¸å…³ç¼“å­˜
3. **å¼€å‘æ¨¡å¼**: ç¦ç”¨ Strict Mode åï¼ŒæŸäº› React å‰¯ä½œç”¨é—®é¢˜å¯èƒ½ä¸ä¼šè¢«åŠæ—¶å‘ç°
4. **å†…å­˜ç®¡ç†**: ç¼“å­˜ä¼šæ¯åˆ†é’Ÿè‡ªåŠ¨æ¸…ç†è¿‡æœŸé¡¹ï¼Œé¿å…å†…å­˜æ³„æ¼

## ğŸ”§ æ•…éšœæ’æŸ¥

### å¦‚æœä»ç„¶çœ‹åˆ°é‡å¤è¯·æ±‚

1. **æ£€æŸ¥æµè§ˆå™¨æ‰©å±•**: æŸäº›æ‰©å±•å¯èƒ½ä¼šé‡å¤è¯·æ±‚
2. **æ¸…é™¤æµè§ˆå™¨ç¼“å­˜**: å¼ºåˆ¶åˆ·æ–°ï¼ˆCtrl+Shift+Rï¼‰
3. **æ£€æŸ¥ Service Worker**: å¯èƒ½æœ‰æ—§çš„ Service Worker ç¼“å­˜
4. **éªŒè¯ç¼“å­˜æ˜¯å¦ç”Ÿæ•ˆ**: åœ¨ Console ä¸­æ£€æŸ¥æ˜¯å¦æœ‰ç¼“å­˜æ—¥å¿—

### è°ƒè¯•ç¼“å­˜

```typescript
// åœ¨æµè§ˆå™¨ Console ä¸­
import { globalRequestCache } from '@/lib/hooks/useRequestCache';

// æ¸…é™¤æ‰€æœ‰ç¼“å­˜
globalRequestCache.invalidate();

// æ¸…é™¤ç‰¹å®šç¼“å­˜
globalRequestCache.invalidate('project:xxx');
```

## ğŸ“š ç›¸å…³æ–‡ä»¶

- `/src/lib/hooks/useRequestCache.ts` - ç¼“å­˜å®ç°
- `/src/lib/services/projectService.ts` - é¡¹ç›®æœåŠ¡
- `/src/lib/services/libraryService.ts` - åº“æœåŠ¡
- `/src/lib/contexts/NavigationContext.tsx` - å¯¼èˆªä¸Šä¸‹æ–‡
- `/src/components/layout/Sidebar.tsx` - ä¾§è¾¹æ ç»„ä»¶
- `/src/app/(dashboard)/[projectId]/[libraryId]/predefine/hooks/useSchemaData.ts` - Schema æ•°æ® hook
- `/next.config.mjs` - Next.js é…ç½®

## ğŸ“ å­¦ä¹ èµ„æº

- [React Query æ–‡æ¡£](https://tanstack.com/query/latest)
- [SWR æ–‡æ¡£](https://swr.vercel.app/)
- [React æ€§èƒ½ä¼˜åŒ–æŒ‡å—](https://react.dev/learn/render-and-commit)
- [ç¼“å­˜ç­–ç•¥æœ€ä½³å®è·µ](https://web.dev/stale-while-revalidate/)

---

**æœ€åæ›´æ–°**: 2026-01-06
**ç‰ˆæœ¬**: 1.0.0

